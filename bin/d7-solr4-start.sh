#!/bin/bash

mydir=$(cd `dirname $(realpath "${BASH_SOURCE[0]}")` && pwd)

command='-Xmx1024m -DSTOP.PORT=8079 -DSTOP.KEY=stopkey -jar start.jar'
name='docker.solr4'
image='twinbit/docker-drupal-solr'
container_hostname='solr4-docker.dev'
hostsfile=/etc/hosts

# cleanup if this container does exist but stopped.
container_running=$(docker ps -a --filter "name=$name" --filter "status=running" --format "{{.ID}}")
if [ "$container_running" != "" ]; then
  echo "Container already running"
else
  container_stopped=$(docker ps -a --filter "name=$name" --filter "status=exited" --format "{{.ID}}")
  if [ "$container_stopped" != "" ]; then
    docker start "$container_stopped"
  else
    docker run --name "$name" -d "$image" ${command}
  fi
fi

ip=$(docker inspect -f '{{ .NetworkSettings.IPAddress }}' ${name})
hostfile_entry="${ip} ${container_hostname} # Generated by d7-docker"

if [ -w ${hostsfile} ]; then
  if [ "$(cat ${hostsfile} | grep ${container_hostname})" != "" ]; then
    cp ${hostsfile} /tmp/.hostsfile
    sed -i "s|^.*${container_hostname}.*\$|${hostfile_entry}|g" /tmp/.hostsfile
    cp /tmp/.hostsfile ${hostsfile}
  else
    echo ${hostfile_entry} >> ${hostsfile}
  fi
else
  echo "I cannot write your hostsfile, so cannot provide you with a nice hostname."
  echo "Do "
  echo "    chown root:$(whoami) /etc/hosts"
  echo "    chmod 770 /etc/hosts"
  echo " in order to fix this..."
  echo ""
  container_hostname=${ip}
fi

echo "Access me on ${container_hostname}:8983/solr"
